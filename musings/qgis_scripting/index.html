<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>QGIS Scripting | Odin</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Well, this was a hard one.
So, those nice maps on each Hurricane page, I made those in a fantastic open source program called QGIS. I&rsquo;ve been using QGIS on and off for years, and it has consistently been up to the GIS tasks I throw at it. When I had access to ArcGIS, I&rsquo;d frequently use QGIS for things ArcGIS couldn&rsquo;t do easily (or that was behind a paid add-on), and when I drew the short straw and lost the ArcGIS seat no one else could tell the difference."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=https://www.odinseye.cloud/ananke/css/main.min.5634740bea2b6888928cdc68ce34cea639f0daf949dc791c38696b64f8558ca0.css><link rel="shortcut icon" href=https://www.odinseye.cloud/img/godin_icon.png type=image/x-icon><meta property="og:title" content="QGIS Scripting"><meta property="og:description" content="Well, this was a hard one.
So, those nice maps on each Hurricane page, I made those in a fantastic open source program called QGIS. I&rsquo;ve been using QGIS on and off for years, and it has consistently been up to the GIS tasks I throw at it. When I had access to ArcGIS, I&rsquo;d frequently use QGIS for things ArcGIS couldn&rsquo;t do easily (or that was behind a paid add-on), and when I drew the short straw and lost the ArcGIS seat no one else could tell the difference."><meta property="og:type" content="article"><meta property="og:url" content="https://www.odinseye.cloud/musings/qgis_scripting/"><meta property="article:section" content="musings"><meta property="article:published_time" content="2021-09-10T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-10T00:00:00+00:00"><meta itemprop=name content="QGIS Scripting"><meta itemprop=description content="Well, this was a hard one.
So, those nice maps on each Hurricane page, I made those in a fantastic open source program called QGIS. I&rsquo;ve been using QGIS on and off for years, and it has consistently been up to the GIS tasks I throw at it. When I had access to ArcGIS, I&rsquo;d frequently use QGIS for things ArcGIS couldn&rsquo;t do easily (or that was behind a paid add-on), and when I drew the short straw and lost the ArcGIS seat no one else could tell the difference."><meta itemprop=datePublished content="2021-09-10T00:00:00+00:00"><meta itemprop=dateModified content="2021-09-10T00:00:00+00:00"><meta itemprop=wordCount content="1014"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="QGIS Scripting"><meta name=twitter:description content="Well, this was a hard one.
So, those nice maps on each Hurricane page, I made those in a fantastic open source program called QGIS. I&rsquo;ve been using QGIS on and off for years, and it has consistently been up to the GIS tasks I throw at it. When I had access to ArcGIS, I&rsquo;d frequently use QGIS for things ArcGIS couldn&rsquo;t do easily (or that was behind a paid add-on), and when I drew the short straw and lost the ArcGIS seat no one else could tell the difference."><script async src="https://www.googletagmanager.com/gtag/js?id=G-KWNZJ4607L"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KWNZJ4607L",{anonymize_ip:!1})}</script></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=https://www.odinseye.cloud/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=https://www.odinseye.cloud/img/godin_icon.png class="w100 mw5-ns" alt=Odin></a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=https://www.odinseye.cloud/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=https://www.odinseye.cloud/announcements/ title="Announcements page">Announcements</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=https://www.odinseye.cloud/hurricane/ title="Hurricanes page">Hurricanes</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=https://www.odinseye.cloud/maps/ title="Map page">Map</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=https://www.odinseye.cloud/musings/ title="Musings page">Musings</a></li></ul></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw9 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">MUSINGS</aside><h1 class="f1 athelas mt3 mb1">QGIS Scripting</h1><p><time class="f6 mv4 dib tracked" datetime=2021-09-10T00:00:00Z>September 10, 2021</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Well, this was a hard one.</p><p>So, those nice maps on each Hurricane page, I made those in a fantastic open source program called <a href=https://www.qgis.org/en/site/>QGIS</a>. I&rsquo;ve been using QGIS on and off for years, and it has consistently been up to the GIS tasks I throw at it. When I had access to ArcGIS, I&rsquo;d frequently use QGIS for things ArcGIS couldn&rsquo;t do easily (or that was behind a paid add-on), and when I drew the short straw and lost the ArcGIS seat no one else could tell the difference. Anyways, enough of the fanboy advertising, but seriously, check it out. Back to the main story: one of the nice things about QGIS is that it&rsquo;s written in Python (well, and lots of C with Python bindings) so, while a bit cumbersome, you can pretty much <code>import qgis</code> (referred to as PyQGIS) and script anything you&rsquo;d like, which is what I did once I sorted out the process manually in the main program. Because while I could do all the steps manually in about 5 minutes, who doesn&rsquo;t like automation.</p><h1 id=environment-setup>Environment Setup</h1><h3 id=cli---the-easy-part>CLI - The Easy Part</h3><p>This was one of the trickiest parts, largely because I never got the environment to play nicely with PyCharm. I use <a href=https://docs.conda.io/en/latest/miniconda.html>Miniconda</a> to manage my Python environments, and some helpful person has set up a PyQGIS package on <code>conda-forge</code>. So, you can follow the standard procedure for setting up a new conda environment and install qgis:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>conda create --name qgis python<span style=color:#f92672>=</span>3.9
</span></span><span style=display:flex><span>conda install -c conda-forge qgis
</span></span></code></pre></div><p>You can test this out with a minimal python script that just instantiates the PyQGIS app, closes, and exits:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> qgis.core <span style=color:#f92672>import</span> QgsApplication
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set up, instantiate, and close application</span>
</span></span><span style=display:flex><span>qgis_app: QgsApplication <span style=color:#f92672>=</span> QgsApplication([], <span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>qgis_app<span style=color:#f92672>.</span>setPrefixPath(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qgis_app<span style=color:#f92672>.</span>initQgis()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qgis_app<span style=color:#f92672>.</span>exitQgis()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># I get a segfault if I don&#39;t do this in the minimal script *shrug*</span>
</span></span><span style=display:flex><span>qgis_app <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;finished&#34;</span>)
</span></span></code></pre></div><p>and run it, unsurprisingly, with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>python minimal_example.py
</span></span></code></pre></div><p>Great, now you have a python environment with PyQGIS installed and a running script, and it won&rsquo;t work with PyCharm (or VSCode) unless you&rsquo;re smarter than me (let me know if you are). All you&rsquo;ll get is errors about how qgis.core can&rsquo;t be located. Couldn&rsquo;t tell you why, but now lets sort out setting up something in the IDE.</p><h3 id=ide---kinda-annoying>IDE - Kinda Annoying</h3><p>So, to set things up with an IDE, the trick is to use the Python interpreter that ships with the normal QGIS application. So the first step is to download and install QGIS using the standard instructions. Next, you need to get the path for the QGIS install directory; there&rsquo;s many ways to do it, but the way to check the source of truth is to ask QGIS itself. Open QGIS, start a Python console (under the plugin directory for me) and run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>QgsApplication<span style=color:#f92672>.</span>prefixPath()
</span></span></code></pre></div><p>this will give you the base path for the QGIS (also, note that prefix thing, it&rsquo;ll come back later). On macOS, this command returned <code>/Applications/QGIS.app/Contents/MacOS</code>. Navigate to that directory, and start hunting for the Python interpreter, I found mine at <code>/Applications/QGIS.app/Contents/MacOS/bin/python3</code>. You can add this interpreter into PyCharm, and then the IDE can start indexing everything as normal. But, the script still won&rsquo;t run as expected, since the PyQGIS object doesn&rsquo;t know where all its libraries are; this is where that prefix comes in. In the minimal script, there is a line where the prefix path gets set:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>qgis_app<span style=color:#f92672>.</span>setPrefixPath(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><p>The first <code>None</code> argument is the path, and in this case it needs to be that path returned in the QGIS Python console. This makes the new minimal script</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Optional
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> qgis.core <span style=color:#f92672>import</span> QgsApplication
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Export path to QGIS sqlite library if needed</span>
</span></span><span style=display:flex><span><span style=color:#75715e># export DYLD_INSERT_LIBRARIES=&#34;/Applications/QGIS.app/Contents/MacOS/lib/libsqlite3.dylib&#34;</span>
</span></span><span style=display:flex><span>qgis_install_path: str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/Applications/QGIS.app/Contents/MacOS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set up application</span>
</span></span><span style=display:flex><span>qgis_app: QgsApplication <span style=color:#f92672>=</span> QgsApplication([], <span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>qgis_app<span style=color:#f92672>.</span>setPrefixPath(qgis_install_path, <span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qgis_app<span style=color:#f92672>.</span>initQgis()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qgis_app<span style=color:#f92672>.</span>exitQgis()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># I get a segfault if I don&#39;t do this in the minimal script *shrug*</span>
</span></span><span style=display:flex><span>qgis_app <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;finished&#34;</span>)
</span></span></code></pre></div><p>Another note, there&rsquo;s a line in there about exporting an environment variable. On my system, the sqlite library wasn&rsquo;t compatible, and I got segfaults with rather cryptic error messages. That environment variable forces the session to call the QGIS library.</p><p>And poof, at the end of all this, you should have a working IDE setup. This was the actual hard part, where I wasn&rsquo;t sure everything would work. The next part is poking QGIS until it does what we want.</p><h1 id=working-with-pyqgis>Working with PyQGIS</h1><p>The PyQGIS docs are, we&rsquo;ll say solidly ok. But, I&rsquo;d suggest doing as many type hints as possible so the IDE will fill in suggestions and save you time in the docs. And you&rsquo;ll have to set most of the type hints manually, the way the files are set up doesn&rsquo;t always make the return types obvious to humans or the IDE.</p><p>Also, because of the C code, there&rsquo;s going to be segfaults. On average, its because something wasn&rsquo;t set up or cleaned up properly. A few segaults I ran into:</p><ul><li>missing the sqlite driver path</li><li>qgis object not fully shutdown</li><li>Invalid layer</li><li>missing files</li></ul><h1 id=scripting-steps>Scripting steps</h1><p>After that, its a matter of figuring out exactly how to script what the goal is. It helps to set up a base project in the normal QGIS application to start with, it saves time fiddling with things in the script. The full script for generating maps is <a href=https://github.com/cliftbar/godin/blob/main/scripts/qgis_layout_exporter.py>on github</a>, so I won&rsquo;t go over it here, but the general steps are:</p><ol><li>Open base project</li><li>Add new layers (setting styles, setting CRS, etc)</li><li>Set map extents to layers</li><li>Open/create a layout and sort out titles, legends, etc<ul><li>this is the most fiddly bit, just keep iterating until it works</li></ul></li><li>Export the finished layout to an image</li></ol><p>And that&rsquo;s scripting with PyQGIS, well the basics of it. PyQGIS can actually be embedded in a standalone GUI application, among other things, but thats far more complicated than what I was going for here. At the end of all this, we have a script that will load the files output from the model code (raster, wld file for raster, and track csv) onto a decently formatted map.</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside><div class=_fa7cdd4c68507744 data-zone=204c5806c2404851a377eda9d8eedf91 style="width:240px;height:400px;display:inline-block;margin:0 auto"></div></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.odinseye.cloud>&copy; Odin 2022</a><div></div></div></footer></body></html>